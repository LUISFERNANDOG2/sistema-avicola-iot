{% extends 'base.html' %}
{% block title %}Devices{% endblock %}
{% block content %}


  <!-- Header -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <div>
      <h3 class="mb-1">ðŸ’¡ Device Management</h3>
      <p class="text-muted mb-0 d-none d-md-block">Monitor and manage all IoT devices and sensors</p>
    </div>
    <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-md-auto">
      <button class="btn btn-primary btn-sm" onclick="refreshAllDevices()">
        <span>ðŸ”„</span> Refresh All
      </button>
      <button class="btn btn-outline-secondary btn-sm" onclick="exportDevices()">
        <span>ðŸ“¥</span> Export
      </button>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-3 mb-3">
      <div class="card p-3 border-start border-success border-4">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted d-block mb-1">Online Devices</small>
            <h4 class="mb-0 text-success" id="onlineCount">24</h4>
            <small class="text-success">96% uptime</small>
          </div>
          <div class="bg-success bg-opacity-10 rounded-circle p-3">
            <span style="font-size: 1.5rem;">ðŸŸ¢</span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card p-3 border-start border-danger border-4">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted d-block mb-1">Offline Devices</small>
            <h4 class="mb-0 text-danger" id="offlineCount">1</h4>
            <small class="text-danger">Requires attention</small>
          </div>
          <div class="bg-danger bg-opacity-10 rounded-circle p-3">
            <span style="font-size: 1.5rem;">ðŸ”´</span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card p-3 border-start border-warning border-4">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted d-block mb-1">Warning Status</small>
            <h4 class="mb-0 text-warning" id="warningCount">2</h4>
            <small class="text-warning">Needs maintenance</small>
          </div>
          <div class="bg-warning bg-opacity-10 rounded-circle p-3">
            <span style="font-size: 1.5rem;">ðŸŸ¡</span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card p-3 border-start border-info border-4">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted d-block mb-1">Total Devices</small>
            <h4 class="mb-0 text-info" id="totalCount">27</h4>
            <small class="text-info">Across 6 houses</small>
          </div>
          <div class="bg-info bg-opacity-10 rounded-circle p-3">
            <span style="font-size: 1.5rem;">ðŸ“¡</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label small fw-bold">Status</label>
          <select class="form-select form-select-sm" id="statusFilter">
            <option value="all">All Status</option>
            <option value="online">Online</option>
            <option value="offline">Offline</option>
            <option value="warning">Warning</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label small fw-bold">House</label>
          <select class="form-select form-select-sm" id="houseFilter">
            <option value="all">All Houses</option>
            <option value="house1">House 1</option>
            <option value="house2">House 2</option>
            <option value="house3">House 3</option>
            <option value="house4">House 4</option>
            <option value="house5">House 5</option>
            <option value="house6">House 6</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label small fw-bold">Device Type</label>
          <select class="form-select form-select-sm" id="typeFilter">
            <option value="all">All Types</option>
            <option value="esp32">ESP32 Node</option>
            <option value="sensor">Sensor</option>
            <option value="gateway">Gateway</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label small fw-bold">Search</label>
          <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="Search devices...">
        </div>
      </div>
    </div>
  </div>

  <!-- Vista de dispositivos -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Device List</h6>
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-secondary active" onclick="switchView('grid')">Grid</button>
            <button type="button" class="btn btn-outline-secondary" onclick="switchView('list')">List</button>
            <button type="button" class="btn btn-outline-secondary" onclick="switchView('map')">Map</button>
          </div>
        </div>
        <div class="card-body p-0">
          <div id="devicesContainer">
            <!-- Los dispositivos se cargarÃ¡n aquÃ­ -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- GrÃ¡fico de estado de dispositivos -->
  <div class="row">
    <div class="col-md-6 mb-3">
      <div class="chart-container">
        <h6 class="mb-3">Device Status Distribution</h6>
        <canvas id="statusChart"></canvas>
      </div>
    </div>
    <div class="col-md-6 mb-3">
      <div class="chart-container">
        <h6 class="mb-3">Uptime Statistics (Last 30 Days)</h6>
        <canvas id="uptimeChart"></canvas>
      </div>
    </div>
  </div>


<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
let statusChart, uptimeChart;
let currentView = 'grid';
let devices = [];

// Datos de ejemplo de dispositivos
const sampleDevices = [
  {
    id: 1,
    name: 'ESP32 Sensor Node - House 1',
    type: 'esp32',
    house: 'House 1',
    status: 'online',
    lastSeen: new Date(Date.now() - 2 * 60000),
    battery: 85,
    signal: -45,
    temperature: 23.2,
    humidity: 54.1,
    firmware: 'v2.1.3',
    location: { x: 10, y: 20 }
  },
  {
    id: 2,
    name: 'ESP32 Sensor Node - House 2',
    type: 'esp32',
    house: 'House 2',
    status: 'offline',
    lastSeen: new Date(Date.now() - 45 * 60000),
    battery: 0,
    signal: 0,
    temperature: null,
    humidity: null,
    firmware: 'v2.1.2',
    location: { x: 30, y: 20 }
  },
  {
    id: 3,
    name: 'Temperature Sensor #1-1',
    type: 'sensor',
    house: 'House 1',
    status: 'online',
    lastSeen: new Date(Date.now() - 1 * 60000),
    battery: 92,
    signal: -42,
    temperature: 23.1,
    humidity: null,
    firmware: 'v1.5.0',
    location: { x: 12, y: 22 }
  },
  {
    id: 4,
    name: 'Humidity Sensor #1-2',
    type: 'sensor',
    house: 'House 1',
    status: 'online',
    lastSeen: new Date(Date.now() - 1 * 60000),
    battery: 88,
    signal: -48,
    temperature: null,
    humidity: 54.2,
    firmware: 'v1.5.0',
    location: { x: 12, y: 18 }
  },
  {
    id: 5,
    name: 'NHâ‚ƒ Sensor #1-3',
    type: 'sensor',
    house: 'House 1',
    status: 'online',
    lastSeen: new Date(Date.now() - 2 * 60000),
    battery: 75,
    signal: -52,
    temperature: null,
    humidity: null,
    firmware: 'v1.4.2',
    location: { x: 8, y: 20 }
  },
  {
    id: 6,
    name: 'COâ‚‚ Sensor #1-4',
    type: 'sensor',
    house: 'House 1',
    status: 'online',
    lastSeen: new Date(Date.now() - 1 * 60000),
    battery: 80,
    signal: -50,
    temperature: null,
    humidity: null,
    firmware: 'v1.4.2',
    location: { x: 14, y: 20 }
  },
  {
    id: 7,
    name: 'ESP32 Sensor Node - House 3',
    type: 'esp32',
    house: 'House 3',
    status: 'online',
    lastSeen: new Date(Date.now() - 3 * 60000),
    battery: 78,
    signal: -55,
    temperature: 22.9,
    humidity: 55.3,
    firmware: 'v2.1.3',
    location: { x: 50, y: 20 }
  },
  {
    id: 8,
    name: 'ESP32 Sensor Node - House 4',
    type: 'esp32',
    house: 'House 4',
    status: 'warning',
    lastSeen: new Date(Date.now() - 25 * 60000),
    battery: 15,
    signal: -72,
    temperature: 23.5,
    humidity: 53.8,
    firmware: 'v2.1.1',
    location: { x: 70, y: 20 }
  },
  {
    id: 9,
    name: 'ESP32 Sensor Node - House 5',
    type: 'esp32',
    house: 'House 5',
    status: 'online',
    lastSeen: new Date(Date.now() - 2 * 60000),
    battery: 65,
    signal: -58,
    temperature: 24.2,
    humidity: 56.1,
    firmware: 'v2.1.3',
    location: { x: 90, y: 20 }
  },
  {
    id: 10,
    name: 'ESP32 Sensor Node - House 6',
    type: 'esp32',
    house: 'House 6',
    status: 'online',
    lastSeen: new Date(Date.now() - 1 * 60000),
    battery: 90,
    signal: -40,
    temperature: 23.3,
    humidity: 53.9,
    firmware: 'v2.1.3',
    location: { x: 110, y: 20 }
  },
  {
    id: 11,
    name: 'Gateway Router #1',
    type: 'gateway',
    house: 'All',
    status: 'online',
    lastSeen: new Date(Date.now() - 1 * 60000),
    battery: null,
    signal: -35,
    temperature: null,
    humidity: null,
    firmware: 'v3.0.1',
    location: { x: 60, y: 10 }
  }
];

function getStatusBadge(status) {
  const badges = {
    online: '<span class="badge bg-success">Online</span>',
    offline: '<span class="badge bg-danger">Offline</span>',
    warning: '<span class="badge bg-warning text-dark">Warning</span>'
  };
  return badges[status] || '';
}

function getSignalStrength(signal) {
  if (signal === 0) return { text: 'N/A', class: 'text-muted' };
  if (signal > -50) return { text: 'Excellent', class: 'text-success' };
  if (signal > -60) return { text: 'Good', class: 'text-info' };
  if (signal > -70) return { text: 'Fair', class: 'text-warning' };
  return { text: 'Poor', class: 'text-danger' };
}

function getBatteryColor(battery) {
  if (battery === null) return 'text-muted';
  if (battery > 50) return 'text-success';
  if (battery > 20) return 'text-warning';
  return 'text-danger';
}

function formatTimeAgo(timestamp) {
  const now = new Date();
  const diff = now - timestamp;
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(minutes / 60);
  
  if (minutes < 1) return 'Just now';
  if (minutes < 60) return `${minutes}m ago`;
  return `${hours}h ago`;
}

function renderDevicesGrid(devicesToRender) {
  const container = document.getElementById('devicesContainer');
  if (devicesToRender.length === 0) {
    container.innerHTML = '<div class="text-center p-5 text-muted">No devices found</div>';
    return;
  }

  container.innerHTML = `
    <div class="row g-3 p-3">
      ${devicesToRender.map(device => {
        const statusColors = {
          online: 'border-success',
          offline: 'border-danger',
          warning: 'border-warning'
        };
        const bgColors = {
          online: 'bg-success bg-opacity-10',
          offline: 'bg-danger bg-opacity-10',
          warning: 'bg-warning bg-opacity-10'
        };
        const signal = getSignalStrength(device.signal);

        return `
          <div class="col-md-4 col-lg-3">
            <div class="card h-100 ${statusColors[device.status]} border-start border-4 ${bgColors[device.status]}" 
                 onclick="viewDeviceDetails(${device.id})" style="cursor: pointer;">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <h6 class="mb-1">${device.name}</h6>
                    <small class="text-muted">${device.house}</small>
                  </div>
                  ${getStatusBadge(device.status)}
                </div>
                
                <div class="mt-3">
                  ${device.battery !== null ? `
                    <div class="mb-2">
                      <div class="d-flex justify-content-between mb-1">
                        <small class="text-muted">Battery</small>
                        <small class="${getBatteryColor(device.battery)}">${device.battery}%</small>
                      </div>
                      <div class="progress" style="height: 6px;">
                        <div class="progress-bar ${device.battery > 50 ? 'bg-success' : device.battery > 20 ? 'bg-warning' : 'bg-danger'}" 
                             style="width: ${device.battery}%"></div>
                      </div>
                    </div>
                  ` : ''}
                  
                  ${device.signal !== 0 ? `
                    <div class="mb-2">
                      <div class="d-flex justify-content-between">
                        <small class="text-muted">Signal</small>
                        <small class="${signal.class}">${signal.text} (${device.signal} dBm)</small>
                      </div>
                    </div>
                  ` : ''}
                  
                  <div class="mb-2">
                    <small class="text-muted">Last seen: ${formatTimeAgo(device.lastSeen)}</small>
                  </div>
                  
                  ${device.temperature !== null ? `
                    <div class="mb-1">
                      <small class="text-muted">Temp: </small>
                      <strong>${device.temperature}Â°C</strong>
                    </div>
                  ` : ''}
                  
                  ${device.humidity !== null ? `
                    <div class="mb-1">
                      <small class="text-muted">Humidity: </small>
                      <strong>${device.humidity}%</strong>
                    </div>
                  ` : ''}
                  
                  <div class="mt-2">
                    <small class="text-muted">Firmware: ${device.firmware}</small>
                  </div>
                </div>
              </div>
              <div class="card-footer bg-transparent">
                <button class="btn btn-sm btn-outline-primary w-100" onclick="event.stopPropagation(); configureDevice(${device.id})">
                  Configure
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

function renderDevicesList(devicesToRender) {
  const container = document.getElementById('devicesContainer');
  if (devicesToRender.length === 0) {
    container.innerHTML = '<div class="text-center p-5 text-muted">No devices found</div>';
    return;
  }

  container.innerHTML = `
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Device</th>
            <th>House</th>
            <th>Status</th>
            <th>Battery</th>
            <th>Signal</th>
            <th>Last Seen</th>
            <th>Firmware</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${devicesToRender.map(device => {
            const signal = getSignalStrength(device.signal);
            return `
              <tr onclick="viewDeviceDetails(${device.id})" style="cursor: pointer;">
                <td><strong>${device.name}</strong><br><small class="text-muted">${device.type}</small></td>
                <td>${device.house}</td>
                <td>${getStatusBadge(device.status)}</td>
                <td>
                  ${device.battery !== null ? `
                    <div class="d-flex align-items-center gap-2">
                      <div class="progress" style="width: 60px; height: 8px;">
                        <div class="progress-bar ${device.battery > 50 ? 'bg-success' : device.battery > 20 ? 'bg-warning' : 'bg-danger'}" 
                             style="width: ${device.battery}%"></div>
                      </div>
                      <small>${device.battery}%</small>
                    </div>
                  ` : '<span class="text-muted">N/A</span>'}
                </td>
                <td>
                  ${device.signal !== 0 ? `
                    <small class="${signal.class}">${signal.text}</small><br>
                    <small class="text-muted">${device.signal} dBm</small>
                  ` : '<span class="text-muted">N/A</span>'}
                </td>
                <td><small>${formatTimeAgo(device.lastSeen)}</small></td>
                <td><small>${device.firmware}</small></td>
                <td>
                  <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); configureDevice(${device.id})">
                    Configure
                  </button>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function filterDevices() {
  const status = document.getElementById('statusFilter').value;
  const house = document.getElementById('houseFilter').value;
  const type = document.getElementById('typeFilter').value;
  const search = document.getElementById('searchInput').value.toLowerCase();

  let filtered = devices.filter(device => {
    if (status !== 'all' && device.status !== status) return false;
    if (house !== 'all' && device.house.toLowerCase() !== house) return false;
    if (type !== 'all' && device.type !== type) return false;
    if (search && !device.name.toLowerCase().includes(search) && 
        !device.house.toLowerCase().includes(search)) return false;
    return true;
  });

  if (currentView === 'grid') {
    renderDevicesGrid(filtered);
  } else if (currentView === 'list') {
    renderDevicesList(filtered);
  }

  updateCounts();
}

function updateCounts() {
  const online = devices.filter(d => d.status === 'online').length;
  const offline = devices.filter(d => d.status === 'offline').length;
  const warning = devices.filter(d => d.status === 'warning').length;
  const total = devices.length;

  document.getElementById('onlineCount').textContent = online;
  document.getElementById('offlineCount').textContent = offline;
  document.getElementById('warningCount').textContent = warning;
  document.getElementById('totalCount').textContent = total;
}

function switchView(view) {
  currentView = view;
  document.querySelectorAll('.btn-group button').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  filterDevices();
}

function viewDeviceDetails(id) {
  const device = devices.find(d => d.id === id);
  if (device) {
    alert(`Device Details:\n\n${JSON.stringify(device, null, 2)}`);
  }
}

function configureDevice(id) {
  const device = devices.find(d => d.id === id);
  if (device) {
    alert(`Configure Device: ${device.name}\n\nThis would open a configuration dialog.`);
  }
}

function refreshAllDevices() {
  alert('Refreshing all devices...');
  // AquÃ­ se harÃ­a una llamada a la API para actualizar el estado
  filterDevices();
}

function exportDevices() {
  const dataStr = JSON.stringify(devices, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `devices_${new Date().toISOString().split('T')[0]}.json`;
  link.click();
}

function initStatusChart() {
  const ctx = document.getElementById('statusChart');
  statusChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Online', 'Offline', 'Warning'],
      datasets: [{
        data: [
          devices.filter(d => d.status === 'online').length,
          devices.filter(d => d.status === 'offline').length,
          devices.filter(d => d.status === 'warning').length
        ],
        backgroundColor: [
          'rgba(67, 160, 71, 0.8)',
          'rgba(229, 57, 53, 0.8)',
          'rgba(255, 193, 7, 0.8)'
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
}

function initUptimeChart() {
  const ctx = document.getElementById('uptimeChart');
  const days = Array.from({length: 30}, (_, i) => {
    const date = new Date();
    date.setDate(date.getDate() - (29 - i));
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  });

  uptimeChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: days,
      datasets: [{
        label: 'Uptime %',
        data: Array.from({length: 30}, () => 95 + Math.random() * 5),
        borderColor: 'rgba(67, 160, 71, 1)',
        backgroundColor: 'rgba(67, 160, 71, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          min: 90,
          max: 100,
          ticks: {
            callback: function(value) {
              return value + '%';
            }
          }
        }
      }
    }
  });
}

// InicializaciÃ³n
document.addEventListener('DOMContentLoaded', function() {
  devices = sampleDevices;
  filterDevices();
  initStatusChart();
  initUptimeChart();

  // Event listeners
  document.getElementById('statusFilter').addEventListener('change', filterDevices);
  document.getElementById('houseFilter').addEventListener('change', filterDevices);
  document.getElementById('typeFilter').addEventListener('change', filterDevices);
  document.getElementById('searchInput').addEventListener('input', filterDevices);
});

</script>

<style>
.chart-container {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.card {
  transition: transform 0.2s, box-shadow 0.2s;
}
.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

@media (max-width: 768px) {
  .chart-container {
    padding: 15px;
  }
  
  #devicesContainer .col-md-4 {
    margin-bottom: 15px;
  }
  
  .table-responsive {
    font-size: 0.85rem;
  }
  
  .btn-group {
    flex-wrap: wrap;
  }
}

@media (max-width: 576px) {
  .chart-container {
    padding: 10px;
  }
  
  h3 {
    font-size: 1.3rem;
  }
  
  .card h4 {
    font-size: 1.2rem;
  }
  
  .table {
    font-size: 0.8rem;
  }
  
  #devicesContainer .col-md-4 {
    flex: 0 0 100%;
    max-width: 100%;
  }
}
</style>

{% endblock %}
