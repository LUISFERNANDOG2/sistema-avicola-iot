{% extends 'base.html' %}
{% block title %}Reports{% endblock %}
{% block content %}


  <!-- Header -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <div>
      <h3 class="mb-1">üìë Report Generator</h3>
      <p class="text-muted mb-0 d-none d-md-block">Generate, schedule, and manage comprehensive farm reports</p>
    </div>
    <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-md-auto">
      <button class="btn btn-primary btn-sm" onclick="openReportGenerator()">
        <span>‚ûï</span> Generate Report
      </button>
      <button class="btn btn-outline-secondary btn-sm" onclick="exportAllReports()">
        <span>üì•</span> Export All
      </button>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-3 mb-3">
      <div class="card p-3 border-start border-primary border-4">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted d-block mb-1">Total Reports</small>
            <h4 class="mb-0 text-primary" id="totalReports">127</h4>
            <small class="text-primary">All time</small>
          </div>
          <div class="bg-primary bg-opacity-10 rounded-circle p-3">
            <span style="font-size: 1.5rem;">üìÑ</span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card p-3 border-start border-success border-4">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted d-block mb-1">This Month</small>
            <h4 class="mb-0 text-success" id="monthReports">18</h4>
            <small class="text-success">+3 from last month</small>
          </div>
          <div class="bg-success bg-opacity-10 rounded-circle p-3">
            <span style="font-size: 1.5rem;">üìä</span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card p-3 border-start border-info border-4">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted d-block mb-1">Scheduled</small>
            <h4 class="mb-0 text-info" id="scheduledReports">5</h4>
            <small class="text-info">Auto-generated</small>
          </div>
          <div class="bg-info bg-opacity-10 rounded-circle p-3">
            <span style="font-size: 1.5rem;">‚è∞</span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card p-3 border-start border-warning border-4">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted d-block mb-1">Pending</small>
            <h4 class="mb-0 text-warning" id="pendingReports">2</h4>
            <small class="text-warning">In queue</small>
          </div>
          <div class="bg-warning bg-opacity-10 rounded-circle p-3">
            <span style="font-size: 1.5rem;">‚è≥</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label small fw-bold">Report Type</label>
          <select class="form-select form-select-sm" id="typeFilter">
            <option value="all">All Types</option>
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label small fw-bold">Status</label>
          <select class="form-select form-select-sm" id="statusFilter">
            <option value="all">All Status</option>
            <option value="completed">Completed</option>
            <option value="pending">Pending</option>
            <option value="scheduled">Scheduled</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label small fw-bold">Date Range</label>
          <select class="form-select form-select-sm" id="dateFilter">
            <option value="all">All Time</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month" selected>This Month</option>
            <option value="year">This Year</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label small fw-bold">Search</label>
          <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="Search reports...">
        </div>
      </div>
    </div>
  </div>

  <!-- Lista de Reportes -->
  <div class="card mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <h6 class="mb-0">Recent Reports</h6>
      <div class="btn-group btn-group-sm" role="group">
        <button type="button" class="btn btn-outline-secondary active" onclick="switchView('list')">List</button>
        <button type="button" class="btn btn-outline-secondary" onclick="switchView('grid')">Grid</button>
      </div>
    </div>
    <div class="card-body p-0">
      <div id="reportsContainer">
        <!-- Los reportes se cargar√°n aqu√≠ -->
      </div>
    </div>
  </div>

  <!-- Report Templates -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header bg-white">
          <h6 class="mb-0">Report Templates</h6>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="card h-100 border">
                <div class="card-body">
                  <h6 class="card-title">üìÖ Daily Summary</h6>
                  <p class="card-text small text-muted">Comprehensive daily report with all sensor data, alerts, and statistics.</p>
                  <ul class="small text-muted">
                    <li>24-hour sensor readings</li>
                    <li>Alert summary</li>
                    <li>Device status</li>
                    <li>Key metrics</li>
                  </ul>
                  <button class="btn btn-sm btn-primary w-100" onclick="generateFromTemplate('daily')">Generate</button>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card h-100 border">
                <div class="card-body">
                  <h6 class="card-title">üìä Weekly Analysis</h6>
                  <p class="card-text small text-muted">Weekly trends, comparisons, and performance analysis.</p>
                  <ul class="small text-muted">
                    <li>7-day trends</li>
                    <li>Statistical analysis</li>
                    <li>Anomaly detection</li>
                    <li>Recommendations</li>
                  </ul>
                  <button class="btn btn-sm btn-primary w-100" onclick="generateFromTemplate('weekly')">Generate</button>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card h-100 border">
                <div class="card-body">
                  <h6 class="card-title">üìà Monthly Report</h6>
                  <p class="card-text small text-muted">Complete monthly overview with insights and forecasts.</p>
                  <ul class="small text-muted">
                    <li>Monthly statistics</li>
                    <li>ML predictions</li>
                    <li>Performance metrics</li>
                    <li>Future projections</li>
                  </ul>
                  <button class="btn btn-sm btn-primary w-100" onclick="generateFromTemplate('monthly')">Generate</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gr√°fico de reportes generados -->
  <div class="row">
    <div class="col-md-12">
      <div class="chart-container">
        <h6 class="mb-3">Reports Generated Over Time</h6>
        <canvas id="reportsChart"></canvas>
      </div>
    </div>
  </div>


<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
let reportsChart;
let currentView = 'list';
let reports = [];

// Datos de ejemplo de reportes
const sampleReports = [
  {
    id: 1,
    name: 'Daily Report - 2025-01-12',
    type: 'daily',
    status: 'completed',
    created: new Date(Date.now() - 2 * 3600000),
    size: '2.4 MB',
    format: 'PDF',
    house: 'All Houses',
    period: '2025-01-12',
    pages: 15
  },
  {
    id: 2,
    name: 'Weekly Analysis - Week 2',
    type: 'weekly',
    status: 'completed',
    created: new Date(Date.now() - 24 * 3600000),
    size: '5.8 MB',
    format: 'PDF',
    house: 'All Houses',
    period: '2025-01-06 to 2025-01-12',
    pages: 32
  },
  {
    id: 3,
    name: 'Monthly Report - January 2025',
    type: 'monthly',
    status: 'completed',
    created: new Date(Date.now() - 3 * 24 * 3600000),
    size: '12.3 MB',
    format: 'PDF',
    house: 'All Houses',
    period: 'January 2025',
    pages: 68
  },
  {
    id: 4,
    name: 'Custom Report - House 6 Analysis',
    type: 'custom',
    status: 'completed',
    created: new Date(Date.now() - 5 * 24 * 3600000),
    size: '3.1 MB',
    format: 'Excel',
    house: 'House 6',
    period: '2025-01-01 to 2025-01-10',
    pages: 24
  },
  {
    id: 5,
    name: 'Daily Report - 2025-01-13',
    type: 'daily',
    status: 'pending',
    created: new Date(Date.now() - 30 * 60000),
    size: 'Generating...',
    format: 'PDF',
    house: 'All Houses',
    period: '2025-01-13',
    pages: null
  },
  {
    id: 6,
    name: 'Weekly Analysis - Week 3',
    type: 'weekly',
    status: 'scheduled',
    created: new Date(Date.now() - 7 * 24 * 3600000),
    size: 'Scheduled',
    format: 'PDF',
    house: 'All Houses',
    period: '2025-01-13 to 2025-01-19',
    pages: null
  },
  {
    id: 7,
    name: 'NH‚ÇÉ Anomaly Report',
    type: 'custom',
    status: 'completed',
    created: new Date(Date.now() - 10 * 24 * 3600000),
    size: '1.9 MB',
    format: 'PDF',
    house: 'House 3',
    period: '2025-01-01 to 2025-01-10',
    pages: 18
  },
  {
    id: 8,
    name: 'Device Status Report',
    type: 'custom',
    status: 'completed',
    created: new Date(Date.now() - 12 * 24 * 3600000),
    size: '0.8 MB',
    format: 'PDF',
    house: 'All Houses',
    period: '2025-01-01',
    pages: 8
  }
];

function getStatusBadge(status) {
  const badges = {
    completed: '<span class="badge bg-success">Completed</span>',
    pending: '<span class="badge bg-warning text-dark">Pending</span>',
    scheduled: '<span class="badge bg-info">Scheduled</span>'
  };
  return badges[status] || '';
}

function getTypeBadge(type) {
  const badges = {
    daily: '<span class="badge bg-primary">Daily</span>',
    weekly: '<span class="badge bg-info">Weekly</span>',
    monthly: '<span class="badge bg-success">Monthly</span>',
    custom: '<span class="badge bg-secondary">Custom</span>'
  };
  return badges[type] || '';
}

function formatDate(date) {
  return date.toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'short', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function formatTimeAgo(date) {
  const now = new Date();
  const diff = now - date;
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(hours / 24);
  
  if (hours < 1) return 'Just now';
  if (hours < 24) return `${hours}h ago`;
  return `${days}d ago`;
}

function renderReportsList(reportsToRender) {
  const container = document.getElementById('reportsContainer');
  if (reportsToRender.length === 0) {
    container.innerHTML = '<div class="text-center p-5 text-muted">No reports found</div>';
    return;
  }

  container.innerHTML = `
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Report Name</th>
            <th>Type</th>
            <th>Status</th>
            <th>House</th>
            <th>Period</th>
            <th>Size</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${reportsToRender.map(report => `
            <tr>
              <td>
                <strong>${report.name}</strong>
                ${report.pages ? `<br><small class="text-muted">${report.pages} pages</small>` : ''}
              </td>
              <td>${getTypeBadge(report.type)}</td>
              <td>${getStatusBadge(report.status)}</td>
              <td>${report.house}</td>
              <td><small>${report.period}</small></td>
              <td><small>${report.size}</small></td>
              <td>
                <small>${formatTimeAgo(report.created)}</small><br>
                <small class="text-muted">${formatDate(report.created)}</small>
              </td>
              <td>
                ${report.status === 'completed' ? `
                  <button class="btn btn-sm btn-outline-primary" onclick="downloadReport(${report.id})">
                    <span>‚¨á</span> Download
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="viewReport(${report.id})">
                    <span>üëÅ</span> View
                  </button>
                ` : ''}
                ${report.status === 'pending' ? `
                  <button class="btn btn-sm btn-outline-warning" onclick="cancelReport(${report.id})">
                    <span>‚úï</span> Cancel
                  </button>
                ` : ''}
                ${report.status === 'scheduled' ? `
                  <button class="btn btn-sm btn-outline-info" onclick="editSchedule(${report.id})">
                    <span>‚öô</span> Edit
                  </button>
                ` : ''}
                <button class="btn btn-sm btn-outline-danger" onclick="deleteReport(${report.id})">
                  <span>üóë</span>
                </button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function renderReportsGrid(reportsToRender) {
  const container = document.getElementById('reportsContainer');
  if (reportsToRender.length === 0) {
    container.innerHTML = '<div class="text-center p-5 text-muted">No reports found</div>';
    return;
  }

  container.innerHTML = `
    <div class="row g-3 p-3">
      ${reportsToRender.map(report => `
        <div class="col-md-4 col-lg-3">
          <div class="card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h6 class="mb-1">${report.name}</h6>
                  ${getTypeBadge(report.type)}
                </div>
                ${getStatusBadge(report.status)}
              </div>
              <div class="small text-muted mb-2">
                <div><strong>House:</strong> ${report.house}</div>
                <div><strong>Period:</strong> ${report.period}</div>
                <div><strong>Size:</strong> ${report.size}</div>
                ${report.pages ? `<div><strong>Pages:</strong> ${report.pages}</div>` : ''}
              </div>
              <div class="small text-muted">
                Created: ${formatTimeAgo(report.created)}
              </div>
            </div>
            <div class="card-footer bg-transparent">
              ${report.status === 'completed' ? `
                <button class="btn btn-sm btn-primary w-100 mb-1" onclick="downloadReport(${report.id})">
                  <span>‚¨á</span> Download
                </button>
                <button class="btn btn-sm btn-outline-secondary w-100" onclick="viewReport(${report.id})">
                  <span>üëÅ</span> View
                </button>
              ` : ''}
              ${report.status === 'pending' ? `
                <button class="btn btn-sm btn-warning w-100" onclick="cancelReport(${report.id})">
                  <span>‚úï</span> Cancel
                </button>
              ` : ''}
              ${report.status === 'scheduled' ? `
                <button class="btn btn-sm btn-info w-100" onclick="editSchedule(${report.id})">
                  <span>‚öô</span> Edit Schedule
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

function filterReports() {
  const type = document.getElementById('typeFilter').value;
  const status = document.getElementById('statusFilter').value;
  const date = document.getElementById('dateFilter').value;
  const search = document.getElementById('searchInput').value.toLowerCase();

  let filtered = reports.filter(report => {
    if (type !== 'all' && report.type !== type) return false;
    if (status !== 'all' && report.status !== status) return false;
    if (search && !report.name.toLowerCase().includes(search) && 
        !report.house.toLowerCase().includes(search)) return false;
    
    if (date !== 'all') {
      const now = new Date();
      const reportDate = report.created;
      const diff = now - reportDate;
      const days = Math.floor(diff / (24 * 3600000));
      
      if (date === 'today' && days > 0) return false;
      if (date === 'week' && days > 7) return false;
      if (date === 'month' && days > 30) return false;
      if (date === 'year' && days > 365) return false;
    }
    
    return true;
  });

  if (currentView === 'list') {
    renderReportsList(filtered);
  } else {
    renderReportsGrid(filtered);
  }

  updateCounts();
}

function updateCounts() {
  const total = reports.length;
  const thisMonth = reports.filter(r => {
    const now = new Date();
    const reportDate = r.created;
    const diff = now - reportDate;
    return diff < 30 * 24 * 3600000;
  }).length;
  const scheduled = reports.filter(r => r.status === 'scheduled').length;
  const pending = reports.filter(r => r.status === 'pending').length;

  document.getElementById('totalReports').textContent = total;
  document.getElementById('monthReports').textContent = thisMonth;
  document.getElementById('scheduledReports').textContent = scheduled;
  document.getElementById('pendingReports').textContent = pending;
}

function switchView(view) {
  currentView = view;
  document.querySelectorAll('.btn-group button').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  filterReports();
}

function downloadReport(id) {
  const report = reports.find(r => r.id === id);
  if (report) {
    alert(`Downloading: ${report.name}`);
  }
}

function viewReport(id) {
  const report = reports.find(r => r.id === id);
  if (report) {
    alert(`Viewing: ${report.name}\n\nThis would open the report in a new window.`);
  }
}

function cancelReport(id) {
  if (confirm('Are you sure you want to cancel this report?')) {
    const report = reports.find(r => r.id === id);
    if (report) {
      report.status = 'cancelled';
      filterReports();
    }
  }
}

function editSchedule(id) {
  const report = reports.find(r => r.id === id);
  if (report) {
    alert(`Edit Schedule: ${report.name}\n\nThis would open a scheduling dialog.`);
  }
}

function deleteReport(id) {
  if (confirm('Are you sure you want to delete this report?')) {
    reports = reports.filter(r => r.id !== id);
    filterReports();
  }
}

function openReportGenerator() {
  alert('This would open a report generator dialog with options to customize the report.');
}

function generateFromTemplate(template) {
  alert(`Generating ${template} report...\n\nThis would start the report generation process.`);
}

function exportAllReports() {
  alert('Exporting all reports...');
}

function initReportsChart() {
  const ctx = document.getElementById('reportsChart');
  const days = Array.from({length: 30}, (_, i) => {
    const date = new Date();
    date.setDate(date.getDate() - (29 - i));
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  });

  reportsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: days,
      datasets: [
        {
          label: 'Daily Reports',
          data: Array.from({length: 30}, () => Math.floor(Math.random() * 3)),
          backgroundColor: 'rgba(67, 160, 71, 0.7)'
        },
        {
          label: 'Weekly Reports',
          data: Array.from({length: 30}, () => Math.floor(Math.random() * 2)),
          backgroundColor: 'rgba(30, 136, 229, 0.7)'
        },
        {
          label: 'Custom Reports',
          data: Array.from({length: 30}, () => Math.floor(Math.random() * 2)),
          backgroundColor: 'rgba(156, 39, 176, 0.7)'
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });
}

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
  reports = sampleReports;
  filterReports();
  initReportsChart();

  // Event listeners
  document.getElementById('typeFilter').addEventListener('change', filterReports);
  document.getElementById('statusFilter').addEventListener('change', filterReports);
  document.getElementById('dateFilter').addEventListener('change', filterReports);
  document.getElementById('searchInput').addEventListener('input', filterReports);
});

</script>

<style>
.chart-container {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.card {
  transition: transform 0.2s;
}
.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

@media (max-width: 768px) {
  .chart-container {
    padding: 15px;
  }
  
  .table-responsive {
    font-size: 0.85rem;
  }
  
  .btn-group {
    flex-wrap: wrap;
  }
  
  #reportsContainer .col-md-4 {
    margin-bottom: 15px;
  }
}

@media (max-width: 576px) {
  .chart-container {
    padding: 10px;
  }
  
  h3 {
    font-size: 1.3rem;
  }
  
  .card h4 {
    font-size: 1.2rem;
  }
  
  .table {
    font-size: 0.8rem;
  }
  
  .table th,
  .table td {
    padding: 0.5rem 0.25rem;
  }
  
  #reportsContainer .col-md-4 {
    flex: 0 0 100%;
    max-width: 100%;
  }
}
</style>

{% endblock %}
